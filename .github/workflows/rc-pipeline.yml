name: RC Pipeline

on:
  push:
    branches:
      - "RC_*"
    tags:
      - "RC_*"

permissions:
  contents: write

jobs:
  release-candidate:
    runs-on: macos-latest
    env:
      BRANCH_NAME: ${{ github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Derive version from ref
        id: vars
        run: |
          tag="${GITHUB_REF_NAME}"            # e.g. RC_v0.5.0
          payload="${tag#RC_}"                # v0.5.0
          version="${payload#v}"              # 0.5.0
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "payload=${payload}" >> "$GITHUB_OUTPUT"
          echo "branch=${tag}" >> "$GITHUB_OUTPUT"

      - name: Prepare RC branch
        run: |
          branch="${{ steps.vars.outputs.branch }}"
          if git ls-remote --exit-code --heads origin "$branch"; then
            git fetch origin "$branch"
            git switch "$branch"
            git branch --set-upstream-to=origin/"$branch" || true
          else
            git switch --create "$branch"
          fi

      - name: Bump Android versionName
        run: |
          python - <<'PY'
          import pathlib, re, sys

          version = "${{ steps.vars.outputs.version }}"
          path = pathlib.Path("composeApp/build.gradle.kts")
          text = path.read_text()
          new_text, count = re.subn(r'versionName\s*=\s*"[^\"]+"', f'versionName = "{version}"', text)
          if count == 0:
              sys.exit("versionName assignment not found in composeApp/build.gradle.kts")
          path.write_text(new_text)
          PY

      - name: Commit version bump
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.email "github-actions@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add composeApp/build.gradle.kts
          if git diff --cached --quiet; then
            echo "No version bump needed; branch already matches."
          else
            git commit -m "chore: bump version to ${{ steps.vars.outputs.version }} for RC"
          fi
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          # Disambiguate from the tag with the same name by pushing the branch ref explicitly
          git push origin HEAD:refs/heads/${{ steps.vars.outputs.branch }}
          git branch --set-upstream-to=origin/${{ steps.vars.outputs.branch }}

      - name: Ensure RC tag exists (branch-triggered)
        if: startsWith(github.ref, 'refs/heads/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${GITHUB_REF_NAME}"
          git fetch --tags origin || true
          if git rev-parse -q "refs/tags/$tag" >/dev/null; then
            echo "Tag $tag already exists; skipping creation."
          else
            git tag "$tag"
            git push origin "refs/tags/$tag"
          fi

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Prepare Firebase credentials
        run: |
          if [ -z "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ]; then
            echo "FIREBASE_SERVICE_ACCOUNT secret is missing; cannot distribute build."
            exit 1
          fi
          if [ -z "${{ secrets.FIREBASE_APP_ID_ANDROID }}" ]; then
            echo "FIREBASE_APP_ID_ANDROID secret is missing; cannot distribute build."
            exit 1
          fi

          cat <<'EOF' > "$HOME/firebase-sa.json"
          ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          EOF

          {
            echo "FIREBASE_SERVICE_ACCOUNT_FILE=$HOME/firebase-sa.json"
            echo "FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID_ANDROID }}"
            echo "FIREBASE_GROUPS=all-testers"
            echo "FIREBASE_RELEASE_NOTES=RC build from ${{ github.ref_name }}"
          } >> "$GITHUB_ENV"
        shell: bash

      - name: Build Android devDebug
        run: ./gradlew :composeApp:assembleDevDebug

      - name: Distribute to Firebase App Tester
        run: ./gradlew :composeApp:appDistributionUploadDevDebug

      - name: Upload Gradle problems report
        if: ${{ always() && hashFiles('build/reports/problems/problems-report.html') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: gradle-problems-report
          path: build/reports/problems/problems-report.html
