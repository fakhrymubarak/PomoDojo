name: RC Pipeline

on:
  push:
    tags:
      - "RC_*"

permissions:
  contents: write

jobs:
  release-candidate:
    runs-on: macos-latest
    env:
      BRANCH_NAME: ${{ github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Derive version from tag
        id: vars
        run: |
          tag="${GITHUB_REF_NAME}"            # e.g. RC_v0.5.0
          payload="${tag#RC_}"                # v0.5.0
          version="${payload#v}"              # 0.5.0
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "payload=${payload}" >> "$GITHUB_OUTPUT"
          echo "branch=${tag}" >> "$GITHUB_OUTPUT"

      - name: Prepare RC branch
        run: |
          branch="${{ steps.vars.outputs.branch }}"
          if git ls-remote --exit-code --heads origin "$branch"; then
            git fetch origin "$branch"
            git switch "$branch"
            git branch --set-upstream-to=origin/"$branch" || true
          else
            git switch --create "$branch"
          fi

      - name: Bump Android versionName
        run: |
          python - <<'PY'
          import pathlib, re, sys

          version = "${{ steps.vars.outputs.version }}"
          path = pathlib.Path("composeApp/build.gradle.kts")
          text = path.read_text()
          new_text, count = re.subn(r'versionName\s*=\s*"[^\"]+"', f'versionName = "{version}"', text)
          if count == 0:
              sys.exit("versionName assignment not found in composeApp/build.gradle.kts")
          path.write_text(new_text)
          PY

      - name: Commit version bump
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.email "github-actions@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add composeApp/build.gradle.kts
          if git diff --cached --quiet; then
            echo "No version bump needed; branch already matches."
          else
            git commit -m "chore: bump version to ${{ steps.vars.outputs.version }} for RC"
          fi
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          # Disambiguate from the tag with the same name by pushing the branch ref explicitly
          git push origin HEAD:refs/heads/${{ steps.vars.outputs.branch }}
          git branch --set-upstream-to=origin/${{ steps.vars.outputs.branch }}

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build Android devDebug
        run: ./gradlew :composeApp:assembleDevDebug

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Configure Firebase credentials
        run: |
          if [ -z "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ]; then
            echo "FIREBASE_SERVICE_ACCOUNT secret is missing; cannot distribute build."
            exit 1
          fi
          if [ -z "${{ secrets.FIREBASE_APP_ID_ANDROID }}" ]; then
            echo "FIREBASE_APP_ID_ANDROID secret is missing; cannot distribute build."
            exit 1
          fi
          cat <<'EOF' > "$HOME/firebase-sa.json"
${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
EOF
          shell: bash

      - name: Distribute to Firebase App Tester
        env:
          GOOGLE_APPLICATION_CREDENTIALS: $HOME/firebase-sa.json
          FIREBASE_CLI_EXPERIMENTAL_GOOGLE_APPLICATION_CREDENTIALS: "1"
        run: |
          firebase appdistribution:distribute composeApp/build/outputs/apk/dev/debug/composeApp-dev-debug.apk \
            --app "${{ secrets.FIREBASE_APP_ID_ANDROID }}" \
            --groups testers \
            --release-notes "RC build from tag ${{ github.ref_name }}"
